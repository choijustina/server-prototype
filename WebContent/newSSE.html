<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>(New) Event Manager</title>

<script type="text/javascript">

// GLOBAL VARIABLES ////////////////////////////////////////
var filterName = "blank";  // replaced finalName
var bodyText;

/*
 * getName - gets the name from the form "filterform", stores it in the variable filterName
 */
function getName(str) {
	var xmlhttp;
	if (str.length==0) {
		filterName = "blank";
		document.getElementById("printName").innerHTML="blank";
		return;
	}
	if (window.XMLHttpRequest) {
		// code for IE7+, Firefox, Chrome, Opera, Safari
		xmlhttp = new XMLHttpRequest();
	} else {
		// code for IE6, IE5
		xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
	}
	
	xmlhttp.onreadystatechange=function() {
		if (xmlhttp.readyState==4 &&  xmlhttp.status==200) {
			filterName = str;
			document.getElementById("printName").innerHTML=str;
		}
	}
	xmlhttp.open("GET", "", true);
	xmlhttp.send();
}

/*
 * printData - 
 */
function printData(d) {
	if (d.id == null) d.id = "-";
	if (d.msgtype == null) d.msgtype = "-";
	if (d.name == null) d.name = "-";
	if (d.doctype == null) d.doctype = "-";
	if (d.data == null) d.data = "-";
	
	var data = "ID: " + d.id
			+ "<br>NAME: " + d.name 
			+ "<br>MSGTYPE: " + d.msgtype 
			+ "<br>DOCTYPE: " + d.doctype 
			+ "<br>DATA: " + d.data 
			+ "<br><br>";
	bodyText = data + bodyText;
	document.getElementById("recv").innerHTML = bodyText;
}
function openConnection() {
	if (typeof (EventSource) != "undefined") {
		var source = new EventSource("http://localhost:8080/SSE/RoutingConsumer");
		
		source.onopen = function(event) {
			bodyText = "Connection was opened<br>"
			document.getElementById("recv").innerHTML = bodyText;
		}
		
		source.onerror = function(event) {
			bodyText = "An error occurred; auto-reconnecting" + "<br>" + bodyText;
			document.getElementById("recv").innerHTML = bodyText;
			if (event.readyState == EventSource.CLOSED) {
				bodyText = "CONNECTION CLOSED<br>" + bodyText;
				document.getElementById("recv").innerHTML = bodyText;
			}
		}
		
		source.addEventListener('clear', function(e) {
			bodyText = "[*]  Waiting for messages...<br>";
			document.getElementById("recv").innerHTML = bodyText;
		}, false);
		
		source.addEventListener('jsonobject', function(e) {
			var d = JSON.parse(e.data);
			printData(d);
			
			//bodyText = e.data + "<br>" + bodyText;
			//document.getElementById("recv").innerHTML = bodyText;
		}, false);
		
		source.onmessage = function(event) {
			bodyText = event.data + "<br>" + bodyText;
			document.getElementById("recv").innerHTML = bodyText;
		}

	}
}


</script>

<!------------- STYLE ------------->
<style>
table,th,td {
	border:1px solid black;
	border-collapse:collapse;
	background: salmon;
}
</style>

</head>
<body>

<!-- REALDoc logo image -->
<img border="0" src="http://localhost:8080/SSE/REALDoc_logo.jpg" style="float:right" width="427" height="132"><br>

<h1>Server-sent Event Manager without iframe 6</h1>

<form id="filterform" action="" method="post">
	Name:<input type="text" name="filterName"/>
	Document type:
		<select name="docType">
			<option value="a">option a</option>
			<option value="b">option b</option>
			<option value="c">option c</option>
			<option value="d">option d</option>
			<option value="e">option e</option>
		</select>
	<input type="submit" value="SUBMIT FIRST">
	<button type="button" onClick="openConnection()">THEN SEARCH</button>
	
	<!-- when using submit, because action="", is refreshing the page?
			need to figure out how to openConnection() on this refresh.. 
			A submit button is used to send form data to a server. The
			data is sent to the page specified in the form's action
			attribute. The file defined in the action attribute usually
			does something with the received input.
			-->
</form>

<br><br>

<table width="500">
<tr>
	<td>Name: <span id="printName"></span></td>
	<td>Document type: <span id="printDocType>"></span></td>
</tr>
<tr>
	<td colspan = "2"><span id="recv"></span></td>
</tr>
</table>

</body>
</html>